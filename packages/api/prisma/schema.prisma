// PA (Personal Assistant) - Database Schema
// ==========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// User Model
// ==========================================

model User {
  id           Int       @id @default(autoincrement())
  username     String    @unique
  passwordHash String    @map("password_hash")
  apiKey       String    @unique @map("api_key")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  projects   Project[]
  labels     Label[]
  notes      Note[]
  actions    Action[]
  blogPosts  BlogPost[]
  companies  Company[]
  jobProfile JobProfile?

  @@map("users")
}

// ==========================================
// Project Model
// ==========================================

model Project {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  name      String
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  notes   Note[]
  actions Action[]

  @@unique([userId, name])
  @@index([userId])
  @@map("projects")
}

// ==========================================
// Label Model
// ==========================================

model Label {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  name      String
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  notes   Note[]   @relation("NoteLabels")
  actions Action[] @relation("ActionLabels")

  @@unique([userId, name])
  @@index([userId])
  @@map("labels")
}

// ==========================================
// Note Model
// ==========================================

model Note {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  projectId Int?     @map("project_id")
  summary   String
  important Boolean  @default(false)
  source    String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  labels  Label[]  @relation("NoteLabels")

  @@index([userId])
  @@index([projectId])
  @@index([important])
  @@index([createdAt])
  @@map("notes")
}

// ==========================================
// Action Model
// ==========================================

model Action {
  id            Int       @id @default(autoincrement())
  userId        Int       @map("user_id")
  projectId     Int?      @map("project_id")
  title         String
  urgency       Int
  importance    Int
  priorityScore Int       @map("priority_score")
  status        String    @default("open")
  source        String
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  completedAt   DateTime? @map("completed_at")

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  labels  Label[]  @relation("ActionLabels")

  @@index([userId])
  @@index([projectId])
  @@index([status])
  @@index([priorityScore(sort: Desc)])
  @@index([createdAt])
  @@map("actions")
}

// ==========================================
// Blog Models
// ==========================================

enum PostStatus {
  DRAFT
  PUBLISHED
  SCHEDULED
}

model BlogPost {
  id              Int        @id @default(autoincrement())
  title           String
  slug            String     @unique
  content         String     @db.Text
  excerpt         String?    @db.VarChar(300)
  featuredImage   String?    @map("featured_image")
  metaDescription String?    @map("meta_description") @db.VarChar(160)
  category        String
  tags            String[]   @default([])
  status          PostStatus @default(DRAFT)
  publishAt       DateTime?  @map("publish_at")
  publishedAt     DateTime?  @map("published_at")
  viewCount       Int        @default(0) @map("view_count")
  authorId        Int        @map("author_id")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  // Relations
  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([slug])
  @@index([status, publishedAt])
  @@index([category])
  @@index([authorId])
  @@map("blog_posts")
}

model BlogCategory {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  slug        String  @unique
  description String?
  sortOrder   Int     @default(0) @map("sort_order")

  @@index([sortOrder])
  @@map("blog_categories")
}

model NewsletterSubscriber {
  id             Int       @id @default(autoincrement())
  email          String    @unique
  subscribedAt   DateTime  @default(now()) @map("subscribed_at")
  consentText    String    @map("consent_text")
  ipAddress      String?   @map("ip_address")
  source         String    @default("blog-sidebar")
  unsubscribedAt DateTime? @map("unsubscribed_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  @@index([email])
  @@index([unsubscribedAt])
  @@map("newsletter_subscribers")
}

model BlogConfig {
  id                 Int      @id @default(1)
  showPromoBanner    Boolean  @default(true) @map("show_promo_banner")
  promoBannerImage   String?  @map("promo_banner_image")
  promoBannerLink    String?  @map("promo_banner_link")
  promoBannerAlt     String?  @map("promo_banner_alt")
  postsPerPage       Int      @default(12) @map("posts_per_page")
  featuredPostsCount Int      @default(5) @map("featured_posts_count")
  siteTitle          String   @default("Tim Callagy") @map("site_title")
  siteDescription    String?  @map("site_description")
  socialLinkedIn     String?  @map("social_linkedin")
  socialGitHub       String?  @map("social_github")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@map("blog_config")
}

// ==========================================
// Job Tracker Models
// ==========================================

model Company {
  id              Int          @id @default(autoincrement())
  userId          Int          @map("user_id")
  name            String
  careerPageUrl   String       @map("career_page_url")
  atsType         String?      @map("ats_type") // greenhouse, lever, workday, ashby, smartrecruiters, custom
  active          Boolean      @default(true)
  // Company metadata
  description     String?      // What the company does (1 sentence)
  headquarters    String?      // HQ location
  foundedYear     Int?         @map("founded_year")
  revenueEstimate String?      @map("revenue_estimate") // e.g. "$10M-$50M", "$100M+"
  stage           String?      // pre-seed, seed, series-a, series-b, series-c, growth, public, acquired
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  // Relations
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobs      JobListing[]
  crawlLogs CrawlLog[]

  @@unique([userId, name])
  @@index([userId])
  @@index([active])
  @@map("companies")
}

model JobProfile {
  id                 Int      @id @default(autoincrement())
  userId             Int      @unique @map("user_id")
  keywords           String[] @default([])
  titles             String[] @default([])
  locations          String[] @default([])
  locationExclusions String[] @default([]) @map("location_exclusions")
  titleExclusions    String[] @default([]) @map("title_exclusions")
  remoteOnly         Boolean  @default(false) @map("remote_only")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("job_profiles")
}

model JobListing {
  id          Int       @id @default(autoincrement())
  companyId   Int       @map("company_id")
  externalId  String    @map("external_id") // Job ID from the source
  title       String
  url         String
  location    String?
  remote      Boolean   @default(false)
  department  String?
  description String?   @db.Text
  postedAt    DateTime? @map("posted_at")
  firstSeenAt DateTime  @default(now()) @map("first_seen_at")
  lastSeenAt  DateTime  @default(now()) @map("last_seen_at")
  status      String    @default("new") // new, viewed, applied, dismissed
  matchScore  Float?    @map("match_score")

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, externalId])
  @@index([companyId])
  @@index([status])
  @@index([matchScore(sort: Desc)])
  @@map("job_listings")
}

model CrawlLog {
  id          Int       @id @default(autoincrement())
  companyId   Int       @map("company_id")
  startedAt   DateTime  @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")
  status      String    @default("running") // running, success, failed
  jobsFound   Int       @default(0) @map("jobs_found")
  newJobs     Int       @default(0) @map("new_jobs")
  error       String?

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([startedAt(sort: Desc)])
  @@map("crawl_logs")
}

// ==========================================
// KPI Driver Tree Models
// ==========================================

model KpiPeriod {
  id        Int       @id @default(autoincrement())
  type      String    // 'monthly' | 'quarterly'
  year      Int
  month     Int?      // 1-12 for monthly, null for quarterly
  quarter   Int?      // 1-4 for quarterly, null for monthly
  label     String    // e.g., "Jan 2026", "Q1 2026"
  startDate DateTime  @map("start_date")
  endDate   DateTime  @map("end_date")
  isCurrent Boolean   @default(false) @map("is_current")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  metricValues KpiMetricValue[]

  @@unique([type, year, month])
  @@unique([type, year, quarter])
  @@index([isCurrent])
  @@map("kpi_periods")
}

model KpiMetric {
  id        Int      @id @default(autoincrement())
  key       String   @unique // e.g., "gross_margin", "revenue"
  name      String   // Display name
  layer     Int      // 1-5
  parentKey String?  @map("parent_key") // Key of parent metric, null for layer 1
  unit      String   // 'percent', 'currency', 'ratio', 'count', 'hours'
  favorable String   // 'up' or 'down'
  formula   String?  // Optional formula description
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  values KpiMetricValue[]

  @@index([layer])
  @@index([parentKey])
  @@map("kpi_metrics")
}

model KpiMetricValue {
  id        Int      @id @default(autoincrement())
  metricId  Int      @map("metric_id")
  periodId  Int      @map("period_id")
  value     Float
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  metric KpiMetric @relation(fields: [metricId], references: [id], onDelete: Cascade)
  period KpiPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)

  @@unique([metricId, periodId])
  @@index([metricId])
  @@index([periodId])
  @@map("kpi_metric_values")
}
