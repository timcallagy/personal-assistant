// PA (Personal Assistant) - Database Schema
// ==========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// User Model
// ==========================================

model User {
  id           Int       @id @default(autoincrement())
  username     String    @unique
  passwordHash String    @map("password_hash")
  apiKey       String    @unique @map("api_key")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  projects  Project[]
  labels    Label[]
  notes     Note[]
  actions   Action[]
  blogPosts BlogPost[]

  @@map("users")
}

// ==========================================
// Project Model
// ==========================================

model Project {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  name      String
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  notes   Note[]
  actions Action[]

  @@unique([userId, name])
  @@index([userId])
  @@map("projects")
}

// ==========================================
// Label Model
// ==========================================

model Label {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  name      String
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  notes   Note[]   @relation("NoteLabels")
  actions Action[] @relation("ActionLabels")

  @@unique([userId, name])
  @@index([userId])
  @@map("labels")
}

// ==========================================
// Note Model
// ==========================================

model Note {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  projectId Int?     @map("project_id")
  summary   String
  important Boolean  @default(false)
  source    String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  labels  Label[]  @relation("NoteLabels")

  @@index([userId])
  @@index([projectId])
  @@index([important])
  @@index([createdAt])
  @@map("notes")
}

// ==========================================
// Action Model
// ==========================================

model Action {
  id            Int       @id @default(autoincrement())
  userId        Int       @map("user_id")
  projectId     Int?      @map("project_id")
  title         String
  urgency       Int
  importance    Int
  priorityScore Int       @map("priority_score")
  status        String    @default("open")
  source        String
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  completedAt   DateTime? @map("completed_at")

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  labels  Label[]  @relation("ActionLabels")

  @@index([userId])
  @@index([projectId])
  @@index([status])
  @@index([priorityScore(sort: Desc)])
  @@index([createdAt])
  @@map("actions")
}

// ==========================================
// Blog Models
// ==========================================

enum PostStatus {
  DRAFT
  PUBLISHED
  SCHEDULED
}

model BlogPost {
  id              Int        @id @default(autoincrement())
  title           String
  slug            String     @unique
  content         String     @db.Text
  excerpt         String?    @db.VarChar(300)
  featuredImage   String?    @map("featured_image")
  metaDescription String?    @map("meta_description") @db.VarChar(160)
  category        String
  tags            String[]   @default([])
  status          PostStatus @default(DRAFT)
  publishAt       DateTime?  @map("publish_at")
  publishedAt     DateTime?  @map("published_at")
  viewCount       Int        @default(0) @map("view_count")
  authorId        Int        @map("author_id")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  // Relations
  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([slug])
  @@index([status, publishedAt])
  @@index([category])
  @@index([authorId])
  @@map("blog_posts")
}

model BlogCategory {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  slug        String  @unique
  description String?
  sortOrder   Int     @default(0) @map("sort_order")

  @@index([sortOrder])
  @@map("blog_categories")
}

model NewsletterSubscriber {
  id             Int       @id @default(autoincrement())
  email          String    @unique
  subscribedAt   DateTime  @default(now()) @map("subscribed_at")
  consentText    String    @map("consent_text")
  ipAddress      String?   @map("ip_address")
  source         String    @default("blog-sidebar")
  unsubscribedAt DateTime? @map("unsubscribed_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  @@index([email])
  @@index([unsubscribedAt])
  @@map("newsletter_subscribers")
}

model BlogConfig {
  id                 Int      @id @default(1)
  showPromoBanner    Boolean  @default(true) @map("show_promo_banner")
  promoBannerImage   String?  @map("promo_banner_image")
  promoBannerLink    String?  @map("promo_banner_link")
  promoBannerAlt     String?  @map("promo_banner_alt")
  postsPerPage       Int      @default(12) @map("posts_per_page")
  featuredPostsCount Int      @default(5) @map("featured_posts_count")
  siteTitle          String   @default("Tim Callagy") @map("site_title")
  siteDescription    String?  @map("site_description")
  socialLinkedIn     String?  @map("social_linkedin")
  socialGitHub       String?  @map("social_github")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@map("blog_config")
}
